;; si-wijesekara.mim -- Sinhala input method with wijesekara method
;; Copyright (C) 2005, 2006, 2008, 2009, 2011
;;   National Institute of Advanced Industrial Science and Technology (AIST)
;;   Registration Number H15PRO112
;; Copyright (C) 2015-2024 Kenichi Handa <handa@gnu.org>

;; This file is part of the m17n database; a sub-part of the m17n
;; library.

;; The m17n library is free software; you can redistribute it and/or
;; modify it under the terms of the GNU Lesser General Public License
;; as published by the Free Software Foundation; either version 2.1 of
;; the License, or (at your option) any later version.

;; The m17n library is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
;; Lesser General Public License for more details.

;; You should have received a copy of the GNU Lesser General Public
;; License along with the m17n library; if not, write to the Free
;; Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
;; Boston, MA 02110-1301, USA.

(input-method si wijesekara (version "1.6.0"))

(description "Sinhala input method based on SLS 1134 Rev. 3:2011.
  <https://www.language.lk/en/download/standards/>
Although this code supports both surrounding text and preedit,
the former is disabled by default to avoid confusion caused by
faulty applications.
")

(title "‡∑É‡∑í")

(variable
 (use-surrounding-text (_"Surrounding text vs. preedit.
If 1, try to use surrounding text.  Otherwise, use preedit.")
		       0 1 0))

(macro
 ;; skip following (virama zwj consonant)* sequence
 (forward
  (set cc3 @+2)
  (cond
   ((& (= @+0 0x0DCA) (= @+1 0x200D) (>= cc3 0x0D9A) (<= cc3 0x0DC6))
    (delete @+3)
    0x0DCA 0x200D
    (insert cc3)
    (forward))))

 (backward
  (set cc1 @-1)
  (cond
   ((& (= @-3 0x0DCA) (= @-2 0x200D) (>= cc1 0x0D9A) (<= cc1 0x0DC6))
    (delete @-3)
    0x0DCA
    0x200D
    (insert cc1)
    (move @<)
    (backward))))

 (delete-preceding-zw
  (cond
   ((| (= @-1 0x200C) (= @-1 0x200D))
    (delete @-1)
    (delete-preceding-zw))))

 (delete-following-zw
  (cond
   ((| (= @+0 0x200C) (= @+0 0x200D))
    (delete @+1)
    (delete-following-zw))))

 (merge-kombuva
  (delete @-1)
  (delete @+2)
  (insert c1)))

(map
 (starter
  ("A") ("B") ("C") ("D") ("E") ("F") ("G") ("H") ("I") ("J") ("K") ("L") ("M")
  ("N") ("O") ("P") ("Q") ("R") ("S") ("T") ("U") ("V") ("W") ("X") ("Y") ("Z") 
  ("a") ("b") ("c") ("d") ("e") ("f") ("g") ("h") ("i") ("j") ("k") ("l") ("m")
  ("n") ("o") ("p") ("q") ("r") ("s") ("t") ("u") ("v") ("w") ("x") ("y") ("z") 
  ("`") ("~") ("\[") ("{") ("\]") ("}") ("\\") ("|") (";") (":") ("'") ("\"")
  (",") ("<") (".") (">")
  ((A-a)) ((A-c)) ((A-o)) ((A-v)) ((A-x)) ((A-z)) ((A-\ )) ((A-.)) ((A-,)) ((A-\'))
  ((G-a)) ((G-c)) ((G-o)) ((G-v)) ((G-x)) ((G-z)) ((G-\ )) ((G-.)) ((G-,)) ((G-\'))
  ((A-0)) ((A-1)) ((A-2)) ((A-3)) ((A-4)) ((A-5)) ((A-6)) ((A-7)) ((A-8)) ((A-9))
  ((G-0)) ((G-1)) ((G-2)) ((G-3)) ((G-4)) ((G-5)) ((G-6)) ((G-7)) ((G-8)) ((G-9))
  ((A-!)) ((A-@)) ((A-#)) ((A-$)) ((A-%)) ((A-^)) ((A-&)) ((A-*)) ((A-\())
  ((G-!)) ((G-@)) ((G-#)) ((G-$)) ((G-%)) ((G-^)) ((G-&)) ((G-*)) ((G-\())
  ((A-Q)) ((A-W)) ((A-E)) ((A-R)) ((A-T)) ((A-Y)) ((A-U)) ((A-I)) ((A-O)) ((A-A)) ((A-S))
  ((G-Q)) ((G-W)) ((G-E)) ((G-R)) ((G-T)) ((G-Y)) ((G-U)) ((G-I)) ((G-O)) ((G-A)) ((G-S))
  ((S-\ )) ((BackSpace)) ((Delete)))

  (consonant
   ("l" "‡∂ö")				; 0D9A
   ("L" "‡∂õ")				; 0D9B
   ("." "‡∂ú")				; 0D9C
   (">" "‡∂ù")				; 0D9D
   ("X" "‡∂û")				; 0D9E
   ((A-.) "‡∂ü")				; 0D9F
   ((G-.) "‡∂ü")				; 0D9F
   ("p" "‡∂†")				; 0DA0
   ("P" "‡∂°")				; 0DA1
   ("c" "‡∂¢")				; 0DA2
   ("C" "‡∂£")				; 0DA3
   ("\[" "‡∂§")				; 0DA4
   ("{" "‡∂•")				; 0DA5
   ((A-c) "‡∂¶")				; 0DA6
   ((G-c) "‡∂¶")				; 0DA6
   ("g" "‡∂ß")				; 0DA7
   ("G" "‡∂®")				; 0DA8
   ("v" "‡∂©")				; 0DA9
   ("V" "‡∂™")				; 0DAA
   ("K" "‡∂´")				; 0DAB
   ((A-v) "‡∂¨")				; 0DAC
   ((G-v) "‡∂¨")				; 0DAC
   (";" "‡∂≠")				; 0DAD
   (":" "‡∂Æ")				; 0DAE
   ("o" "‡∂Ø")				; 0DAF
   ("O" "‡∂∞")				; 0DB0
   ("k" "‡∂±")				; 0DB1
   ((A-o) "‡∂≥")				; 0DB3
   ((G-o) "‡∂≥")				; 0DB3
   ("m" "‡∂¥")				; 0DB4
   ("M" "‡∂µ")				; 0DB5
   ("n" "‡∂∂")				; 0DB6
   ("N" "‡∂∑")				; 0DB7
   ("u" "‡∂∏")				; 0DB8
   ("U" "‡∂π")				; 0DB9
   ("h" "‡∂∫")				; 0DBA
   ("r" "‡∂ª")				; 0DBB
   ("," "‡∂Ω")				; 0DBD
   ("j" "‡∑Ä")				; 0DC0
   ("Y" "‡∑Å")				; 0DC1
   ("I" "‡∑Ç")				; 0DC2
   ("i" "‡∑É")				; 0DC3
   ("y" "‡∑Ñ")				; 0DC4
   ("<" "‡∑Ö")				; 0DC5
   ("F" "‡∑Ü")				; 0DC6
   )

  (misc
   ("x" "‡∂Ç")				; 0D82
   ((A-x) "‡∂É")				; 0D83
   ((G-x) "‡∂É")				; 0D83

   ("w" "‡∂Ö")				; 0D85
   ("b" "‡∂â")				; 0D89
   ("B" "‡∂ä")				; 0D8A
   ("W" "‡∂ã")				; 0D8B
   ("R" "‡∂ç")				; 0D8D
   ((A-,) "‡∂è")				; 0D8F
   ((G-,) "‡∂è")				; 0D8F

   ("T" "‡∂î")				; 0D94

   ("s" "‡∑í")				; 0DD2
   ("S" "‡∑ì")				; 0DD3
   ("q" "‡∑î")				; 0DD4

   ("Q" "‡∑ñ")				; 0DD6

   ((A-0) "‡∑¶")				; 0DE6
   ((G-0) "‡∑¶")				; 0DE6
   ((A-1) "‡∑ß")				; 0DE7
   ((G-1) "‡∑ß")				; 0DE7
   ((A-2) "‡∑®")				; 0DE8
   ((G-2) "‡∑®")				; 0DE8
   ((A-3) "‡∑©")				; 0DE9
   ((G-3) "‡∑©")				; 0DE9
   ((A-4) "‡∑™")				; 0DEA
   ((G-4) "‡∑™")				; 0DEA
   ((A-5) "‡∑´")				; 0DEB
   ((G-5) "‡∑´")				; 0DEB
   ((A-6) "‡∑¨")				; 0DEC
   ((G-6) "‡∑¨")				; 0DEC
   ((A-7) "‡∑≠")				; 0DED
   ((G-7) "‡∑≠")				; 0DED
   ((A-8) "‡∑Æ")				; 0DEE
   ((G-8) "‡∑Æ")				; 0DEE
   ((A-9) "‡∑Ø")				; 0DEF
   ((G-9) "‡∑Ø")				; 0DEF

   ((A-!) "ëá°")				; 111E1
   ((G-!) "ëá°")				; 111E1
   ((A-@) "ëá¢")				; 111E2
   ((G-@) "ëá¢")				; 111E2
   ((A-#) "ëá£")				; 111E3
   ((G-#) "ëá£")				; 111E3
   ((A-$) "ëá§")				; 111E4
   ((G-$) "ëá§")				; 111E4
   ((A-%) "ëá•")				; 111E5
   ((G-%) "ëá•")				; 111E5
   ((A-^) "ëá¶")				; 111E6
   ((G-^) "ëá¶")				; 111E6
   ((A-&) "ëáß")				; 111E7
   ((G-&) "ëáß")				; 111E7
   ((A-*) "ëá®")				; 111E8
   ((G-*) "ëá®")				; 111E8
   ((A-\() "ëá©")				; 111E9
   ((G-\() "ëá©")				; 111E9
   ((A-Q) "ëá™")				; 111EA
   ((G-Q) "ëá™")				; 111EA
   ((A-W) "ëá´")				; 111EB
   ((G-W) "ëá´")				; 111EB
   ((A-E) "ëá¨")				; 111EC
   ((G-E) "ëá¨")				; 111EC
   ((A-R) "ëá≠")				; 111ED
   ((G-R) "ëá≠")				; 111ED
   ((A-T) "ëáÆ")				; 111EE
   ((G-T) "ëáÆ")				; 111EE
   ((A-Y) "ëáØ")				; 111EF
   ((G-Y) "ëáØ")				; 111EF
   ((A-U) "ëá∞")				; 111F0
   ((G-U) "ëá∞")				; 111F0
   ((A-I) "ëá±")				; 111F1
   ((G-I) "ëá±")				; 111F1
   ((A-O) "ëá≤")				; 111F2
   ((G-O) "ëá≤")				; 111F2
   ((A-A) "ëá≥")				; 111F3
   ((G-A) "ëá≥")				; 111F3
   ((A-S) "ëá¥")				; 111F4
   ((G-S) "ëá¥")				; 111F4

   ((A-a) "‡∑≥")				; 0DF3
   ((G-a) "‡∑≥")				; 0DF3
   ((A-\') "‡∑¥")				; 0DF4
   ((G-\') "‡∑¥")				; 0DF4

   ("\]" ";")
   ("}" ":")
   ("'" ".")
   ("\"" ",")
   ("z" "'")
   ("Z" "\"")

   ("|" "‚Äç‡∑ä")				; touch (ZWJ 0DCA)
   ("J" "‡∑Ö‡∑î")				; muurdhaja lu (0DC5 0DD4)
   ((S-\ ) "¬†")				; NBSP
   ((A-\ ) "‚Äå")				; ZWNJ
   ((G-\ ) "‚Äå")				; ZWNJ

   ("t"
    (set c @-2)
    (cond
     ((= @-1 0x0DD9)
      (cond
       ((= c 0x200C)
	(delete @-2)
	0x0D93)
       ((| (< c 0x0D9A) (> c 0x0DC6))
	(delete @-1)
	0x0D93)
       (1
	0x0D91)))
     (1
      0x0D91)))

   ("a"
    (set c @-1)
    (cond
     ((= c 0x0D91)
      (delete @-1)
      0x0D92)
     ((= c 0x0D94)
      (delete @-1)
      0x0D95)
     ((= c 0x0DD9)
      (delete @-1)
      0x0DDA)
     ((= c 0x0DDC)
      (delete @-1)
      0x0DDD)
     (1
      0x0DCA)))

   ("d"
    (set c @-1)
    (cond
     ((= c 0x0D85)
      (delete @-1)
      0x0D86)
     ((= c 0x0DD9)
      (delete @-1)
      0x0DDC)
     (1
      0x0DCF)))

   ("e"
    (cond
     ((= @-1 0x0D85)
      (delete @-1)
      0x0D87)
     (1
      0x0DD0)))

   ("E"
    (set c @-1)
    (cond
     ((= c 0x0D85)
      (delete @-1)
      0x0D88)
     ((= c 0x0DD4)
      (cond
       ((= @-2 0x0DC5)
	(delete @-1)
	0x0DD6)
       (1
	0x0DD1)))
     (1
      0x0DD1)))     

   ("D"
    (set c @-1)
    (cond
     ((= c 0x0D8D)
      (delete @-1)
      0x0D8E)
     ((= c 0x0DD8)
      (delete @-1)
      0x0DF2)
     (1
      0x0DD8)))

   ("A"
    (set c @-1)
    (cond
     ((= c 0x0D8B)
      (delete @-1)
      0x0D8C)
     ((= c 0x0D8F)
      (delete @-1)
      0x0D90)
     ((= c 0x0D94)
      (delete @-1)
      0x0D96)
     ((= c 0x0DD9)
      (delete @-1)
      0x0DDE)
     (1
      0x0DDF)))

   ("f"
    (set c @+0)
    (cond
     ((& (>= c 0x0D9A) (<= c 0x0DC6))
      (delete @+1)
      (insert c)
      (forward)
      (set c @+0)
      (cond
       ((= c 0x0DCA)
	(delete @+1)
	0x0DDA)
       ((= c 0x0DD9)
	(delete @+1)
	0x0DDB)
       ((= c 0x0DCF)
	(delete @+1)
	0x0DDC)
       ((= c 0x0DDF)
	(delete @+1)
	0x0DDE)
       (1
	0x0DD9)))
     ((= c 0x0D91)
      (delete @+1)
      0x0D93)
     ((= c 0x0DD9)
      (delete @+1)
      0x0DDB)
     ((& (= c 0x200C) (= @+1 0x0DD9))
      (delete @+2)
      0x200C 0x0DDB)
     ((& (= @-1 0x0DD9)
	 (| (< @-2 0x0D9A) (> @-2 0x0DC6)))
      (delete @-1)
      0x0DDB)
     ((& (>= @-1 0x0D9A) (<= @-1 0x0DC6))
      0x200C 0x0DD9)
     (1
      0x0DD9)))
   
   ;; sanyaka letters
   ((A-z)
    (set c @-1)
    (cond
     ((= c 0x0DAF)
      (delete @-1)
      0x0DB3)
     ((= c 0x0D9C)
      (delete @-1)
      0x0D9F)
     ((= c 0x0DA9)
      (delete @-1)
      0x0DAC)
     ((= c 0x0DA2)
      (delete @-1)
      0x0DA6)))
   
   ;; sanyaka letters
   ((G-z)
    (set c @-1)
    (cond
     ((= c 0x0DAF)
      (delete @-1)
      0x0DB3)
     ((= c 0x0D9C)
      (delete @-1)
      0x0D9F)
     ((= c 0x0DA9)
      (delete @-1)
      0x0DAC)
     ((= c 0x0DA2)
      (delete @-1)
      0x0DA6)))

   ;; yansaya
   ("H"
    (set c @-1)
    (cond
     ((= c 0x0DD9)
      (delete @-1))
     ((= c 0x0DDB)
      (delete @-1))
     (1
      (set c 0)))
    (cond
     ((& (>= @-1 0x0D9A) (<= @-1 0x0DC6))
      0x0DCA 0x200D 0x0DBA))
    (cond
     ((> c 0)
      (insert c))))

   ;; rakaransaya
   ("`"
    (set c @-1)
    (cond
     ((| (= c 0x0DD9) (= c 0x0DDB) (= c 0x0DD2) (= c 0x0DD3))
      (delete @-1))
     (1
      (set c 0)))
    (cond
     ((& (>= @-1 0x0D9A) (<= @-1 0x0DC6))
      0x0DCA 0x200D 0x0DBB))
    (cond
     ((> c 0)
      (insert c))))

   ;; repaya
   ("~"
    (set c @-1)
    (cond
     ((| (= c 0x0DD9) (= c 0x0DDB))
      (delete @-1))
     (1
      (set c 0)))
    (backward)
    (cond
     ((& (>= @-1 0x0D9A) (<= @-1 0x0DC6))
      (set c1 @-1)
      (delete @-1)
      (insert c1)
      (move @<)
      0x0DBB 0x0DCA 0x200D))
    (cond
     ((> c 0)
      (move @>)
      (insert c))))

   ((BackSpace)
    (delete-preceding-zw)
    (set c @-1)
    (cond
     ((< c 0)
      (unhandle)))
    (delete @-1)
    (cond
     ((= c 0x0D86)
      0x0D85)
     ((= c 0x0D87)
      0x0D85)
     ((= c 0x0D88)
      0x0D85)
     ((= c 0x0D8C)
      0x0D8B)
     ((= c 0x0D8E)
      0x0D8D)
     ((= c 0x0D90)
      0x0D8F)
     ((= c 0x0D92)
      0x0D8F)
     ((= c 0x0D93)
      (cond ((& (>= @-1 0x0D9A) (<= @-1 0x0DC6)) 0x200C))
      0x0DD9)
     ((= c 0x0D95)
      0x0D94)
     ((= c 0x0D96)
      0x0D94)

     ((& (>= c 0x0D9A) (<= c 0x0DC6) (= @-2 0x0DCA) (= @-1 0x200D))
      (cond
       ((= @-3 0x0DBB)
	(delete @-3)
	(insert c))
       (1
	(delete @-2))))

     ((= c 0x0DD9)
      (cond
       ((| (< @-1 0x0D9A) (> @-1 0x0DC6)))
       ((= @+0 0x0D91)
	(delete @-1)
	(delete @+1)
	0x0D93)
       ((& (>= @+0 0x0D9A) (<= @+0 0x0DC6))
	(set c1 @+0)
	(cond
	 ((= @+1 0x0DD9)
	  (merge-kombuva)
	  0x0DDB)
	 ((= @+1 0x0DCA)
	  (merge-kombuva)
	  0x0DDA)
	 ((= @+1 0x0DCF)
	  (merge-kombuva)
	  0x0DDC)
	 ((= @+1 0x0DDF)
	  (merge-kombuva)
	  0x0DDE)
	 (1
	  (delete @-1)
	  (delete @+1)
	  (insert c1)
	  0x0DD9)))
       ((& (>= @-2 0x0D9A) (<= @-2 0x0DC6))
	(delete @-1)
	0x200C
	0x0DD9)
       ((& (= @-4 0x0DBB) (= @-3 0x0DCA) (= @-2 0x200D))
	(set c1 @-1)
	(delete @-4)
	(insert c1)
	0x0DD9)
       ((& (>= @-4 0x0D9A) (<= @-4 0x0DC6) (= @-3 0x0DCA) (= @-2 0x200D))
	(delete @-3)
	0x0DD9)
       (1
	(delete @-1)
	0x0DD9)))

     ((= c 0x0DDA)
      0x0DD9)

     ((= c 0x0DDB)
      (cond
       ((| (< @-1 0x0D9A) (> @-1 0x0DC6))
	0x0DD9)
       ((& (>= @-2 0x0D9A) (<= @-2 0x0DC6))
	(delete @-1)
	0x200C
	0x0DDB)
       ((& (= @-4 0x0DBB) (= @-3 0x0DCA) (= @-2 0x200D))
	(set c1 @-1)
	(delete @-4)
	(insert c1)
	0x0DDB)
       ((& (>= @-4 0x0D9A) (<= @-4 0x0DC6) (= @-3 0x0DCA) (= @-2 0x200D))
	(delete @-3)
	0x0DDB)
       (1
	(delete @-1)
	0x0DDB)))

     ((= c 0x0DDC)
      0x0DD9)
     ((= c 0x0DDD)
      0x0DDC)
     ((= c 0x0DDE)
      0x0DD9)
     ((= c 0x0DF2)
      0x0DD8))

    (cond
     ((& (>= @-1 0x0D9A)
	 (<= @-1 0x0DC6)
	 (| (= @+0 0x0DD9) (= @+0 0x0DDB)))
      0x200C)))

   ((Delete)
    (delete-following-zw)
    (set c @+0)
    (cond
     ((< c 0)
      (unhandle)))
    (delete @+1)
    (cond
     ((= c 0x0D86)
      0x0DCF)
     ((= c 0x0D87)
      0x0DD0)
     ((= c 0x0D88)
      0x0DD1)
     ((= c 0x0D8C)
      0x0DDF)
     ((= c 0x0D8E)
      0x0DD8)
     ((= c 0x0D90)
      0x0DDF)
     ((= c 0x0D92)
      0x0DCA)
     ((= c 0x0D93)
      0x0D91)
     ((& (>= c 0x0D9A) (<= c 0x0DC6))
      (forward)
      (cond
       ((= @+0 0x0DD9)
	(delete @+1)
	(move @<)
	(insert c))
       ((= @+0 0x0DDB)
	(delete @+1)
	0x0DD9
	(move @<)
	(insert c))
       ((= @+0 0x0DDA)
	(delete @+1)
	0x0DCA
	(move @<)
	(insert c))
       ((= @+0 0x0DDC)
	(delete @+1)
	0x0DCF
	(move @<)
	(insert c))
       ((= @+0 0x0DDE)
	(delete @+1)
	0x0DDF
	(move @<)
	(insert c))
       (1
	(delete @<))))
     ((= c 0x0DDB)
      0x0DD9))))

  (independent
   ("w" "‡∂Ö")				; 0D85
   ("b" "‡∂â")				; 0D89
   ("B" "‡∂ä")				; 0D8A
   ("W" "‡∂ã")				; 0D8B
   ("R" "‡∂ç")				; 0D8D
   ((A-,) "‡∂è")				; 0D8F
   ((G-,) "‡∂è")				; 0D8F
   ("t" "‡∂ë")				; 0D91
   ("T" "‡∂î")				; 0D94
   ("l" "‡∂ö")				; 0D9A
   ("L" "‡∂õ")				; 0D9B
   ("." "‡∂ú")				; 0D9C
   (">" "‡∂ù")				; 0D9D
   ("X" "‡∂û")				; 0D9E
   ((A-.) "‡∂ü") ((0x2E A-z) "‡∂ü")		; 0D9F
   ((G-.) "‡∂ü") ((0x2E G-z) "‡∂ü")		; 0D9F
   ("p" "‡∂†")				; 0DA0
   ("P" "‡∂°")				; 0DA1
   ("c" "‡∂¢")				; 0DA2
   ("C" "‡∂£")				; 0DA3
   ("\[" "‡∂§")				; 0DA4
   ("{" "‡∂•")				; 0DA5
   ((A-c) "‡∂¶") ((0x63 A-z) "‡∂¶")		; 0DA6
   ((G-c) "‡∂¶") ((0x63 G-z) "‡∂¶")		; 0DA6
   ("g" "‡∂ß")				; 0DA7
   ("G" "‡∂®")				; 0DA8
   ("v" "‡∂©")				; 0DA9
   ("V" "‡∂™")				; 0DAA
   ("K" "‡∂´")				; 0DAB
   ((A-v) "‡∂¨") ((0x76 A-z) "‡∂¨")		; 0DAC
   ((G-v) "‡∂¨") ((0x76 G-z) "‡∂¨")		; 0DAC
   (";" "‡∂≠")				; 0DAD
   (":" "‡∂Æ")				; 0DAE
   ("o" "‡∂Ø")				; 0DAF
   ("O" "‡∂∞")				; 0DB0
   ("k" "‡∂±")				; 0DB1
   ((A-o) "‡∂≥") ((0x6F A-z) "‡∂≥")		; 0DB3
   ((G-o) "‡∂≥") ((0x6F G-z) "‡∂≥")		; 0DB3
   ("m" "‡∂¥")				; 0DB4
   ("M" "‡∂µ")				; 0DB5
   ("n" "‡∂∂")				; 0DB6
   ("N" "‡∂∑")				; 0DB7
   ("u" "‡∂∏")				; 0DB8
   ("U" "‡∂π")				; 0DB9
   ("h" "‡∂∫")				; 0DBA
   ("r" "‡∂ª")				; 0DBB
   ("," "‡∂Ω")				; 0DBD
   ("j" "‡∑Ä")				; 0DC0
   ("Y" "‡∑Å")				; 0DC1
   ("I" "‡∑Ç")				; 0DC2
   ("i" "‡∑É")				; 0DC3
   ("y" "‡∑Ñ")				; 0DC4
   ("<" "‡∑Ö")				; 0DC5
   ("F" "‡∑Ü")				; 0DC6

   ((A-0) "‡∑¶")				; 0DE6
   ((G-0) "‡∑¶")				; 0DE6
   ((A-1) "‡∑ß")				; 0DE7
   ((G-1) "‡∑ß")				; 0DE7
   ((A-2) "‡∑®")				; 0DE8
   ((G-2) "‡∑®")				; 0DE8
   ((A-3) "‡∑©")				; 0DE9
   ((G-3) "‡∑©")				; 0DE9
   ((A-4) "‡∑™")				; 0DEA
   ((G-4) "‡∑™")				; 0DEA
   ((A-5) "‡∑´")				; 0DEB
   ((G-5) "‡∑´")				; 0DEB
   ((A-6) "‡∑¨")				; 0DEC
   ((G-6) "‡∑¨")				; 0DEC
   ((A-7) "‡∑≠")				; 0DED
   ((G-7) "‡∑≠")				; 0DED
   ((A-8) "‡∑Æ")				; 0DEE
   ((G-8) "‡∑Æ")				; 0DEE
   ((A-9) "‡∑Ø")				; 0DEF
   ((G-9) "‡∑Ø")				; 0DEF

   ((A-!) "ëá°")				; 111E1
   ((G-!) "ëá°")				; 111E1
   ((A-@) "ëá¢")				; 111E2
   ((G-@) "ëá¢")				; 111E2
   ((A-#) "ëá£")				; 111E3
   ((G-#) "ëá£")				; 111E3
   ((A-$) "ëá§")				; 111E4
   ((G-$) "ëá§")				; 111E4
   ((A-%) "ëá•")				; 111E5
   ((G-%) "ëá•")				; 111E5
   ((A-^) "ëá¶")				; 111E6
   ((G-^) "ëá¶")				; 111E6
   ((A-&) "ëáß")				; 111E7
   ((G-&) "ëáß")				; 111E7
   ((A-*) "ëá®")				; 111E8
   ((G-*) "ëá®")				; 111E8
   ((A-\() "ëá©")				; 111E9
   ((G-\() "ëá©")				; 111E9
   ((A-Q) "ëá™")				; 111EA
   ((G-Q) "ëá™")				; 111EA
   ((A-W) "ëá´")				; 111EB
   ((G-W) "ëá´")				; 111EB
   ((A-E) "ëá¨")				; 111EC
   ((G-E) "ëá¨")				; 111EC
   ((A-R) "ëá≠")				; 111ED
   ((G-R) "ëá≠")				; 111ED
   ((A-T) "ëáÆ")				; 111EE
   ((G-T) "ëáÆ")				; 111EE
   ((A-Y) "ëáØ")				; 111EF
   ((G-Y) "ëáØ")				; 111EF
   ((A-U) "ëá∞")				; 111F0
   ((G-U) "ëá∞")				; 111F0
   ((A-I) "ëá±")				; 111F1
   ((G-I) "ëá±")				; 111F1
   ((A-O) "ëá≤")				; 111F2
   ((G-O) "ëá≤")				; 111F2
   ((A-A) "ëá≥")				; 111F3
   ((G-A) "ëá≥")				; 111F3
   ((A-S) "ëá¥")				; 111F4
   ((G-S) "ëá¥")				; 111F4

   ((A-\') "‡∑¥")				; 0DF4
   ((G-\') "‡∑¥")				; 0DF4

   ("|" "‚Äç‡∑ä")				; touch (ZWJ 0DCA)
   ("J" "‡∑Ö‡∑î")				; muurdhaja lu (0DC5 0DD4)

   ((S-\ ) "¬†")				; NBSP (00A0)
   ((A-\ ) "‚Äå")				; ZWNJ (200C)
   ((G-\ ) "‚Äå")				; ZWNJ (200C)

   ("\]" ";")
   ("}" ":")
   ("'" ".")
   ("\"" ",")
   ("z" "'")
   ("Z" "\"")
   )

  (dependent
   ("x" "‡∂Ç")				; 0D82
   ((A-x) "‡∂É")				; 0D83
   ((G-x) "‡∂É")				; 0D83
   ("a"
    (cond
     ((= @-1 0x0D91) (delete @-) "‡∂í")	; 0D92
     ((= @-1 0x0D94) (delete @-) "‡∂ï")	; 0D95
     ((= @-1 0x0DD9) (delete @-) "‡∑ö")	; 0DDA
     ((= @-1 0x0DDC) (delete @-) "‡∑ù")	; 0DDD
     (1 "‡∑ä")))				; 0DCA
   ("d"
    (cond
     ((= @-1 0x0D85) (delete @-) "‡∂Ü")	; 0D86
     ((= @-1 0x0DD9) (delete @-) "‡∑ú")	; 0DDC
     (1 "‡∑è")))				; 0DCF
   ("e"
    (cond
     ((= @-1 0x0D85) (delete @-) "‡∂á")	; 0D87
     (1 "‡∑ê")))				; 0DD0
   ("E"
    (cond
     ((= @-1 0x0D85) (delete @-) "‡∂à")	; 0D88
     ((& (= @-2 0x0DC5) (= @-1 0x0DD4))
      (delete @-) "‡∑ñ")			; 0DD6
     (1 "‡∑ë")))				; 0DD1
   ("s" "‡∑í")				; 0DD2
   ("S" "‡∑ì")				; 0DD3
   ("q" "‡∑î")				; 0DD4
   ("Q" "‡∑ñ")				; 0DD6

   ("D"
    (cond
     ((= @-1 0x0D8D) (delete @-) "‡∂é")	; 0D8E
     ;; The following line does not work when no consonant proceeds.
     ;;    ((= @-1 0x0DD8) (delete @-) "‡∑≤")	; 0DF2
     (1 "‡∑ò")))				; 0DD8
   ;; This one works with or without a preceeding consonant.
   ("DD" "‡∑≤") 				; 0DF2

   ("A"
    (cond
     ((= @-1 0x0D8B) (delete @-) "‡∂å")	; 0D8C
     ((= @-1 0x0D8F) (delete @-) "‡∂ê")	; 0D90
     ((= @-1 0x0D94) (delete @-) "‡∂ñ")	; 0D96
     ((= @-1 0x0DD9) (delete @-) "‡∑û")	; 0DDE
     (1 "‡∑ü")))				; 0DDF
   ((A-a) "‡∑≥")				; 0DF3
   ((G-a) "‡∑≥")				; 0DF3

   ("H"					; yansaya (0DCA 200D 0DBA)
    (cond
     ((| (= @-1 0x0DD9) (= @-1 0x0DDB))
      (move @-) "‡∑ä‚Äç‡∂∫" (move @>))
     (1
      "‡∑ä‚Äç‡∂∫")))

   ("`"					; rakaransaya (0DCA 200D 0DBB)
    (cond
     ((| (= @-1 0x0DD2) (= @-1 0x0DD3) (= @-1 0x0DD9) (= @-1 0x0DDB))
      (move @-) "‡∑ä‚Äç‡∂ª" (move @>))
     (1 "‡∑ä‚Äç‡∂ª")))

   ("~"					; repaya (0DBB 0DCA 200D)
    (move @<)
    "‡∂ª‡∑ä‚Äç"
    (move @>))
   )

  (kombuva
   ("f" "‡∑ô"))				; 0DD9

  (join
   ("\\"))

  (backspace
   ((BackSpace))))

(state
 (init
  (starter
   (pushback 1)
   (cond
    ((& (= use-surrounding-text 1) (= @-0 -1))
     (shift surrounding-text))
    (1
     (shift preedit)))))

 (surrounding-text
  (consonant
   (move @<)
   (cond
    ((= @-1 0x0DD9)
     (cond
      ((= @-2 0x200C)
       (delete @-2)
       (move @>)
       0x0DD9)
      ((| (< @-2 0x0D9A) (> @-2 0x0DC6))
       (delete @-1)
       (move @>)
       0x0DD9)))
    ((= @-1 0x0DDB)
     (cond
      ((= @-2 0x200C)
       (delete @-2)
       (move @>)
       0x0DDB)
      ((| (< @-2 0x0D9A) (> @-2 0x0DC6))
       (delete @-1)
       (move @>)
       0x0DDB))))
   (commit))
  (misc
   (commit))
  (join
   (shift join)))

 (join
  (consonant
   (move @<)
   (set c @-1)
   (cond
    ((| (= c 0x0DD9) (= c 0x0DDB))
     (cond
      ((& (>= @-2 0x0D9A) (<= @-2 0x0DC6))
       (delete @-1)
       0x0DCA 0x200D
       (move @>)
       (insert c))))
    ((& (>= c 0x0D9A) (<= c 0x0DC6))
     0x0DCA 0x200D))
   (commit)
   (shift surrounding-text))

  (nil
   (commit)
   (shift surrounding-text)))

 (preedit
  (independent
   (shift independent-state))
  (kombuva
   (shift kombuva-state))
  (dependent)
  (nil
   (unhandle)))

 (independent-state
  (dependent)
  (join
   (cond
    ((| (= @-1 0x0DD9) (= @-1 0x0DDB))
     (shift join-state))
    ((| (< @-1 0x0D9A) (> @-1 0x0DC6))
     (undo -1))
    (1
     (shift join-state))))
  (backspace
   (undo)))

 (join-state
  (t
   (mark p))
  (independent
   (move p)
   (set c @-1)
   (cond
    ((| (= c 0x0DD9) (= c 0x0DDB))
     (delete @-)
     "‡∑ä‚Äç"				; 0DCA 200D
     (move @>)
     (insert c))
    (1
     "‡∑ä‚Äç"				; 0DCA 200D
     (move @>)))
   (shift independent-state))
  (backspace
   (undo)))

 (kombuva-state
  (t
   (mark p))
  (independent
   (cond
    ((& (= @0 0x0DD9) (= @1 0x0D91))
     (delete @<)
     "‡∂ì"				; 0D93
     (shift independent-state))
    ((& (= @0 0x0DD9) (< @2 0))
     (move @0)
     (delete @+)
     (move @>)
     "‡∑ô"				; 0DD9
     (shift independent-state))
    ((& (= @0 0x0DDB) (< @2 0))
     (move @0)
     (delete @+)
     (move @>)
     "‡∑õ"				; 0DDB
     (shift independent-state))
    (1
     (delete p)
     (pushback 1)
     (shift preedit))))
  (kombuva
   (mark p)
   (cond
    ((& (= @0 0x0DD9) (< @2 0))
     (delete @<)
     "‡∑õ")				; 0DDB
    (1
     (delete @-)
     (pushback 1)
     (shift preedit))))
  (dependent
   (mark p))
  (backspace
   (undo))))

;; Local Variables:
;; coding: utf-8
;; mode: emacs-lisp
;; End:
